<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Robot Dashboard | PongWorks</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #131722;
            color: #fff;
            text-align: center;
            margin: 0;
            padding-top: 80px; /* makes room for fixed banner */
        }

        .header-banner {
            width: 100%;
            background-color: #0079fe; /* Bootstrap blue */
            padding: 10px 0;
            margin: 0;
            position: fixed;       /* stays stuck to top */
            top: 0;
            left: 0;
            z-index: 1000;
        }

        .header-banner h1 {
            margin: 0;
            font-variant: small-caps;
        }


        /* Command button */
        .flat-btn {
            padding: 10px 28px;
            font-size: 1.2rem;
            border: 2px solid #fff3;
            background: #fff1;
            border-radius: 8px;
            color: white;
            backdrop-filter: blur(5px);
            transition: 0.25s;
        }
        .flat-btn:hover {
            background: #fff2;
        }
        .flat-btn.start {
            background: rgba(255,193,7,0.25);
            border-color: #ffc107;
            color: #ffc107;
        }
        .flat-btn.stop {
            background: rgba(220,53,69,0.2);
            border-color: #dc3545;
            color: #dc3545;
        }
        .flat-btn.disconnected {
            background: rgba(20,20,20,0.2);
            border-color: #303030;
            color: #303030;
        }

        
        /* Main content */
        .main-container {
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: 30px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* Right column that holds Vars + Minimap */
        .right-column {
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* spaces Vars above Minimap */
            width: 30vw;
            max-width: 480px;
            min-width: 250px;
        }

        /* Vars section */
        .variables {
            flex: 1;
            background: #1b2130;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            overflow-y: auto;
            text-align: left;
        }
        
        .video-container {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;             /* restore rounded edges */
            overflow: hidden;                /* crop overflowing video corners */
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            background: #1b2130;                /* keeps it neat when video not loaded */
        }

        .video-container img {
            width: 60vw;                     /* scale video with screen width */
            max-width: 800px;                /* cap on large screens */
            height: auto;
            display: block;
            border-radius: 0;                /* handled by container */
        }

        /* Minimap below it */
        .minimap-container {
            margin-top: 15px;
            background: #1b2130;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        /* Minimap smaller + cropped */
        .minimap-container img {
            width: 100%;
            max-height: 200px;               /* cap vertical space */
            object-fit: cover;               /* crop vertically instead of stretching */
            border-radius: 8px;
            display: block;
        }

        footer {
            margin-top: 30px;
            font-size: 0.9rem;
            color: #bbb;
        }

        .placeholder {
            background: #0f131c;
            color: #708090;
            font-size: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .feed-placeholder {
            width: 60vw;
            max-width: 800px;
            aspect-ratio: 4 / 3;
            border-radius: 12px;
        }

        .minimap-placeholder {
            width: 100%;
            max-height: 200px;
            aspect-ratio: 4 / 3;
            border-radius: 8px;
        }


        /* Responsive fallback */
        @media (max-width: 900px) {
            .main-container {
                flex-direction: column;
                align-items: center;
            }
            .video-container img,
            .right-column {
                width: 90vw;
                max-width: none;
            }
        }

        /* Handling "PongWorks Dashboard" banner on mobile */
        @media (max-width: 600px) {
            .header-banner {
                padding: 5px 0;
            }

            .header-banner h1 img {
                height: 40px;      /* smaller logo */
            }

            .header-banner h1 {
                font-size: 1.4rem; /* smaller title text */
            }

            body {
                padding-top: 60px; /* reduce reserved space */
            }
        }
    </style>
</head>
<body>
    <!-- <div class="header-banner">
        <h1><img src="/static/favicon.png" height="60px"> PongWorks Dashboard</h1>
    </div> -->
    <div class="header-banner d-flex justify-content-between align-items-center px-4">
        <h1 class="m-0">
            <img src="/static/favicon.png" height="60px">
            <div id="banner" style="display: inline-block;">PongWorks Dashboard</div>
        </h1>

        <!-- Admin-only button (hidden by default) -->
        <button id="command-btn" class="flat-btn disconnected" style="display:none;">
            Disconnected...
        </button>
    </div>

    <div class="main-container">
        <div class="video-container">
            <div id="feed-wrapper" class="feed-placeholder placeholder">
                Disconnected
            </div>
            <img id="feed" alt="Live Feed" style="display:none;">
        </div>

        <div class="right-column">
            <div class="variables">
                <h3>Live Variables</h3>
                <div id="var-list"></div>
            </div>

            <div class="minimap-container">
                <h4>Minimap</h4>
                <div id="minimap-wrapper" class="minimap-placeholder placeholder">
                    Disconnected
                </div>
                <img id="minimap" alt="Minimap" style="display:none;">
            </div>
        </div>
    </div>

    <footer>
        © 2025 PongWorks | ese1110f25 team 19
    </footer>

    <script>
        // Load admin token from localStorage (only admin browser has this)
        const adminToken = localStorage.getItem("admin_token");
        console.log(`User ${adminToken}`);

        // Send admin token from localStorage → Cookie, so Flask routes can see it
        (function syncAdminCookie() {
            if (!adminToken) return;

            fetch("/set_admin_cookie", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ token: adminToken })
            });
        })();

        // Build WebSocket URL with ?admin_token=...
        const wsUrl =
            `${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/video_feed`
            + (adminToken ? `?admin_token=${adminToken}` : "");

        const img = document.getElementById('feed');
        const varList = document.getElementById('var-list');
        const vars = {};

        const ws = new WebSocket(wsUrl);
        ws.binaryType = 'arraybuffer';

        ws.onmessage = (event) => {
            if (event.data === "SERVER_FULL") {
                alert("Sorry, the server is full. Please try again later.");
                ws.close();
                window.location.replace("/full");  // Redirect to a Flask page
                return;
            }

            if (typeof event.data === 'string') {
                if (event.data.startsWith('VAR_UPDATE:')) {
                    const [, name, value] = event.data.split(':');
                    if (name === "running") {
                        robotRunning = (value === "True");
                        updateCommandButton();
                    }
                    vars[name] = value;
                    updateVarList();
                }
                return;
            }

            const bytes = new Uint8Array(event.data);
            const msgType = bytes[0];
            const payload = bytes.slice(1);
            const base64 = arrayBufferToBase64(payload);

            switch (msgType) {
                case 1: // Main feed
                    document.getElementById('feed-wrapper').style.display = "none";
                    img.style.display = "block";
                    img.src = 'data:image/jpeg;base64,' + base64;
                    break;
                case 3: // Minimap feed
                    document.getElementById('minimap-wrapper').style.display = "none";
                    const mm = document.getElementById('minimap');
                    mm.style.display = "block";
                    mm.src = 'data:image/jpeg;base64,' + base64;
                    break;
            }
        };


        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const chunkSize = 0x8000;
            for (let i = 0; i < bytes.length; i += chunkSize) {
                binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunkSize));
            }
            return btoa(binary);
        }

        function updateVarList() {
            const sorted = Object.keys(vars).sort();

            if (sorted.length === 0) {
                varList.innerHTML = `<div style="
                    text-align:center;
                    margin-top:20px;
                    color:#708090;
                    font-style:italic;
                ">No Variables to Show</div>`;
                return;
            }

            varList.innerHTML = sorted
                .map(k => `<div class="var-item">${k}: ${vars[k]}</div>`)
                .join('');
        }
        updateVarList();

        ws.onclose = () => {
            console.log("Disconnected, retrying soon...");
            setTimeout(() => location.reload(), 1000);
        };

        // --- Admin Start/Stop Button -----------------------------------
        const commandBtn = document.getElementById("command-btn");
        const banner = document.getElementById("banner");
        let robotRunning = false;

        function updateCommandButton() {
            if (!commandBtn.style.display || commandBtn.style.display === "none") return;

            commandBtn.classList.remove("disconnected");
            if (robotRunning) {
                commandBtn.textContent = "Stop Robot";
                commandBtn.classList.remove("start");
                commandBtn.classList.add("stop");
            } else {
                commandBtn.textContent = "Start Robot";
                commandBtn.classList.remove("stop");
                commandBtn.classList.add("start");
            }
        }


        // Only show button if this browser is admin
        if (adminToken === "1e2d1c30ba116e0661a79fa751ab4f8e87b8a9efbc53004cffad7b33742e4ec2") {
            commandBtn.style.display = "inline-block";
            banner.textContent = "PongWorks Dashboard - Admin";
        }

        // Send command to Flask, then Pi
        commandBtn.onclick = async () => {
            if (commandBtn.textContent!=="Start Robot" && commandBtn.textContent!=="Stop Robot") {
                alert("Can't send command! Robot is disconnected.");
                return;
            }
            commandBtn.disabled = true;

            const endpoint = "/command_robot";
            let command_running = !robotRunning;

            try {
                await fetch(endpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({command_running})
                });
            } catch (err) {
                alert("Failed to send command.");
            }

            commandBtn.disabled = false;
        };

    </script>
</body>
</html>
